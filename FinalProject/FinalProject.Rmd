---
title: "Forecasting the 2018 California Legislative Election"
author: "EJ Arce"
date: "4/2/2017"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, include = FALSE)
library(foreign)
library(dplyr)
library(tidyverse)
library(tidyr)
library(readxl)
library(ggplot2)
library(leaflet)
library(rgdal)
library(maptools)
library(rgeos)
library(gpclib)
library(scales)
library(shiny)
library(lme4)
```

### Importing election results data

We are importing three datasets and we will eventually join them. LegResults6814 consists of every candidate who ran for a seat in the California State Legislature from 1968 to 2014. LegResults16 includes such candidates who ran in 2016. Threeoffices includes the voting totals for three US offices (Presidential, Gubernatorial, and US Senate) in each of the California senatorial and assembly districts, from 1966 to 2016. This dataset previously consisted of three separate datasets, which Jonathan and I cleaned in R or excel, to create threeoffices.

```{r, warning=FALSE, message=FALSE}
LegResults6814 <- read.dta("~/Desktop/state-forecasting-alpha/032_StateLegForecast_CAcopy/SLERs1967to2015_20160912b_CA.dta")

LegResults16 <- read_excel("~/Desktop/state-forecasting-alpha/032_StateLegForecast_CAcopy/001_CA2016GenOfficecopy.xls")

threeoffices <- read_excel("~/Desktop/state-forecasting-alpha/032_StateLegForecast_CAcopy/threeoffices662016copy.xlsx")
```

### Cleaning election results data

For both datasets, we want each observation to represent a given chamber's district's voting totals for both national and state legislative offices, each office including a democratic or republican candidate. It is certainly possible that some candidates for a legislative office ran unopposed or against a third-party candidate, resulting in some blank entries.

```{r, warning=FALSE, message=FALSE}

# Selecting and renaming variables of interest, and filtering the dataset to only include democratic and republican candidates. 

LegResults6814 <- LegResults6814 %>%
  select(v05, v07, v09z, v21, v22, v23) %>%
  rename(year = v05,
         chamber = v07,
         District = v09z,
         party = v21,
         incumbency = v22,
         votes = v23) %>%
  filter(party == c(100, 200))
LegResults6814$chamber <- ifelse(LegResults6814$chamber == 8, "SEN", "HS")
LegResults6814$party <- ifelse(LegResults6814$party == 100, "Dem", "Repub")
LegResults6814 <- aggregate(x = LegResults6814["votes"], by = LegResults6814[c("year", "chamber", "District", "party", "incumbency")], sum)

# Coding dummy variables prez_party (1 if the president is a Democrat, -1 if the president is a Republican) and mid_penalty (1 if the president is a Democrat, -1 if the president is a Republican, 0 if the year includes a presidential election).

threeoffices$prez_party <- ifelse(threeoffices$year %in% c(1968, 1978,1980,1994,1996,1998,2000,2010,2012,2014,2016), 1, -1)
threeoffices$mid_penalty <- ifelse(threeoffices$year %in% c(1968,1972,1976,1980,1984,1988,1992,1996,2000,2004,2008,2012, 2016), 0, ifelse(LegResults6814$year %in% c(1970,1974,1982,1986,1990,2002,2006), -1, 1))

# Coding for dummy variable incumbent (1 if the seat up for election is held by a democrat, -1 if held by a Republican, 0 if the seat is open).

LegResults6814 <- LegResults6814  %>%
  mutate(dummyparty = ifelse(party == "Dem", 1, -1)) %>%
  mutate(incumbentparty = dummyparty * incumbency) %>%
  spread(key = party, value = votes) %>%
  filter(year > 1972)
LegResults6814[is.na(LegResults6814)] <- 0

# Repeating the same steps for LegResults16

LegResults16 <- LegResults16 %>%
  select(v05, v07, v09, partyoriginal, v23, incumbency) %>%
  rename(year = v05,
         chamber = v07,
         District = v09,
         party = partyoriginal,
         votes = v23) %>%
  filter(party == c("Democratic", "Republican"))
LegResults16$chamber <- ifelse(LegResults16$chamber == 8, "SEN", "HS")
LegResults16$party <- ifelse(LegResults16$party == "Democratic", "Dem", "Repub")
LegResults16 <- aggregate(x = LegResults16["votes"], by = LegResults16[c("year", "chamber", "District", "party", "incumbency")], sum)
LegResults16 <- LegResults16  %>%
  mutate(dummyparty = ifelse(party == "Dem", 1, -1)) %>%
  mutate(incumbentparty = dummyparty * incumbency) %>%
  spread(key = party, value = votes) %>%
  filter(year > 1972)
LegResults16[is.na(LegResults16)] <- 0

head(LegResults6814)
head(LegResults16)
```

We have selected variables of interest and created new variables that will be useful for our model. Each observation still represents how a district voted for each candidate, so we need to aggregate the votes in the republican and democrat candidate columns so that each observation represents how a district voted for both parties' candidates.

```{r}
# Aggregating rows by votes so that our LegResults 6814 dataset is now a district's legislative election

LegResults6814 <- aggregate(x = LegResults6814[c("Dem",
                                                 "Repub",
                                                 "incumbency",
                                                 "incumbentparty",
                                                 "dummyparty")],
                            by = LegResults6814[c("year",
                                                  "chamber",
                                                  "District")],
                            sum)

LegResults16 <- aggregate(x = LegResults16[c("Dem",
                                             "Repub",
                                             "incumbency",
                                             "incumbentparty",
                                             "dummyparty")],
                          by = LegResults16[c("year",
                                              "chamber",
                                              "District")],
                          sum)
```

Our dataset on voting totals for presidential, gubernatorial, and US Senate offices was mostly tidy, and any modifications to it were made in excel. We now only need to select the variables of interest, remove unnecessary rows (some rows contained sidenotes for the data), and rename the district column to match with our legislative results dataset.

```{r}
threeoffices <- threeoffices %>%
  filter(Dummy1 == 1,
         year > 1972) %>%
  select(year, chamber, dist, (17:24), prez_party, mid_penalty) %>%
  rename(District = dist)
```

Now both datasets are clean, and we will join them soon. However, first we need to add data on presidential approval ratings and percent change in real income (courtesy of Gallup and the Department of Commerce). Both datasets were collected at the national level.

### Importing and cleaning presidential approval and economy strength data

```{r}
Econ_State <- read_excel("~/Desktop/state-forecasting-alpha/032_StateLegForecast_CAcopy/econ-strength.xls")
PrezApprove <- read_excel("~/Desktop/state-forecasting-alpha/032_StateLegForecast_CAcopy/Gallup_Prez_Approv_1966to2016.xlsx")

PrezApprove <- PrezApprove %>%
  select(Year, Approve) %>%
  rename(year = Year)

# For percent change in real income, we are using Dr. Klarner's weighted percent change formula. This includes attributing the highest weight to the quarter that just passed (January through March) and the lowest weight to the most outdated quarter (April through June of the previous year). The reason we are doing this is because we expect that voters focus more on how the economy has changed now, and less 10 months ago. First, we need to measure percent change for each quarter. Our dataset only gives raw income values, so the first mutation creates percent changes for each quarter, and our second mutation creates our weighted annual percent change.

Econ_State <- Econ_State %>%
  spread(key = Quarter, value = Income) %>%
  mutate(I_IIpercent = (II-I)/I,
         II_IIIpercent = (lag(III)-lag(II))/lag(II),
         III_IVpercent = (lag(IV)-lag(III))/lag(III),
         IV_Ipercent = (I - lag(IV))/lag(IV)) %>%
  mutate(perc_change = (4*I_IIpercent +
                        3*IV_Ipercent +
                        2*III_IVpercent +
                        IV_Ipercent)/10) %>%
  rename(year = Year)
```

### Joining legislative elections data with threeoffices, and joining Econ_State and PrezApprove to Results

```{r}
# First joining the legislative results from 2016 to legislative results from 1968 through 2014.

LegResults <- full_join(LegResults16, LegResults6814, by = c("year", "chamber", "District",  "Dem", "Repub", "incumbentparty", "incumbency", "dummyparty"))

# Joining the entire legislative results to US offices results.

Results <- full_join(LegResults, threeoffices, by = c("year", "chamber", "District"))

# Joining presidential approval and percent change in real income data to the Results. Also creating another presidential approval rating variable that multiplies the rating by -1 if the president is republican.

Results <- left_join(Results, Econ_State, by = "year")
Results <- left_join(Results, PrezApprove, by = "year")

# Adding another incumbent variable, this time to explicitly describe which party holds the incumbency. Also adding a categorical variable Leg_winner to represent which party captured the legislative seat.

Results <- Results %>%
  rename(Leg_Dem = Dem, Leg_Repub = Repub) %>%
  mutate(incumb_party_name = ifelse(incumbentparty == 1, "Democrat", ifelse(incumbentparty == 0, "No incumbent", "Republican")),
         Leg_winner = ifelse(Leg_Repub > Leg_Dem, "Republican", "Democract"),
         perc_Dem = Leg_Dem / (Leg_Dem + Leg_Repub),
         perc_Repub = Leg_Repub / (Leg_Dem + Leg_Repub)) %>%
  arrange(year, chamber, District) %>%
  mutate(perc_prez_Dem = Prez_Dem/(Prez_Dem + Prez_Repub),
         perc_sen_Dem = US_Sen_Dem/(US_Sen_Dem + US_Sen_Repub),
         perc_sen2_Dem = US_Sen2_Dem/(US_Sen2_Dem + US_Sen2_Repub),
         perc_gub_Dem = Gub_Dem/(Gub_Dem + Gub_Repub))
```

### Fully clean dataset

```{r}
head(Results)
```

### Importing CA shapefiles

To visualiza our data, we would like to include a map of California senatorial and assembly districts. The shapefiles necessary to do this were obtained from the Census Bureau.

```{r}
SENshape <- readShapePoly("~/Desktop/state-forecasting-alpha/032_StateLegForecast_CAcopy/CA_SEN_shapefile/cb_2016_06_sldu_500k.shp")
HSshape <- readShapePoly("~/Desktop/state-forecasting-alpha/032_StateLegForecast_CAcopy/CA_HS_shapefile/cb_2016_06_sldl_500k.shp")

SENshapefort <- fortify(SENshape, region = "NAME")
HSshapefort <- fortify(HSshape, region = "NAME")
```

### Some visualizations

```{r}
plot1 <- ggplot(Results, aes(y = Leg_Dem, x = Leg_Repub)) +
  geom_point(mapping = aes(col = incumb_party_name)) +
  scale_colour_manual(values = c("blue", "grey", "red")) +
  geom_abline(intercept = 0, slope = 1) +
  ylab("Vote count for the Democratic Candidate") +
  xlab("Vote count for the Republican Candidate") +
  labs(col = "Incumbency status") +
  ggtitle("The incumbency effect")
plot1
```

```{r}
# Creating a subset of Results that only includes senatorial district voting totals in 2014.

SEN14 <- Results %>%
  filter(year == 2014, chamber == "SEN")

SEN14map <- ggplot() +
  geom_map(data = SEN14,
           aes(map_id = District, fill = perc_Dem),
           map = SENshape) +
  expand_limits(x = SENshapefort$long, y = SENshapefort$lat) +
  scale_fill_gradient2(low = muted("red"),
                       mid = "white", midpoint = .5,
                       high = muted("blue"),
                       limits = c(0, 1),
                       na.value = "grey") +
  labs(fill = "Proportion voting for a Democrat") +
  ggtitle("Voting outcomes in the 2014 California State Senate Election")
SEN14map
```

## Create a Mixed Effects Model

```{r}

# We need to code for NAs so that the observations used in our model will not
# be excluded if one of the variables we use include an NA. We will store these
# changes under a new dataset Resultsmodel. Also, we will code for lagged
# variables, which include observations for each variable from the previous
# election.

Resultsmodel <- Results %>%
  mutate(perc_changeLag = lag(perc_change, 120),
         ApproveLag = lag(Approve, 120),
         incumbentpartyLag = lag(incumbentparty, 120),
         DemLag = lag(perc_Dem, 120))

Resultsmodel[c("Leg_Dem",
          "Leg_Repub",
          "Prez_Dem",
          "Prez_Repub",
          "incumbency",
          "incumbentparty",
          "dummyparty",
          "Gub_Dem",
          "Gub_Repub",
          "US_Sen_Dem",
          "US_Sen_Repub",
          "US_Sen2_Dem",
          "US_Sen2_Repub")][is.na(Resultsmodel[c("Leg_Dem",
                                      "Leg_Repub",
                                      "Prez_Dem",
                                      "Prez_Repub",
                                      "incumbency",
                                      "incumbentparty",
                                      "dummyparty",
                                      "Gub_Dem",
                                      "Gub_Repub",
                                      "US_Sen_Dem",
                                      "US_Sen_Repub",
                                      "US_Sen2_Dem",
                                      "US_Sen2_Repub")])] <- 0
Resultsmodel[c("perc_Dem",
          "perc_Repub",
          "perc_prez_Dem",
          "perc_sen_Dem",
          "perc_sen2_Dem",
          "perc_gub_Dem")][is.na(Resultsmodel[c("perc_Dem",
                                           "perc_Repub",
                                           "perc_prez_Dem",
                                           "perc_sen_Dem",
                                           "perc_sen2_Dem",
                                           "perc_gub_Dem")])] <- .5
Resultsmodel["Leg_winner"][is.na(Resultsmodel["Leg_winner"])] <- "No election"
```

```{r, warning=FALSE, message=FALSE}
m1 <- lmer(perc_Dem ~ incumbentparty + (Approve|prez_party), Resultsmodel)

m3 <- lmer(perc_Dem ~
             DemLag + incumbentpartyLag +
             (1|year/District) +
             incumbentparty + (1 + incumbentparty|year),
             Resultsmodel)
AIC(m3)
AIC(m1)
```